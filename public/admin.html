<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - Leads Raros Capital</title>
  <style>
    :root {
      --dourado: #bfa34a;
      --dourado-escuro: #8c7b2a;
      --preto: #1d1d1d;
      --branco: #ffffff;
      --fundo-claro: #f8f8f8;
      --fundo-escuro: #121212;
      --texto-escuro: #222;
      --texto-claro: #ddd;
    }
    body {
      margin: 0; padding: 20px;
      font-family: Arial, sans-serif;
      background-color: var(--fundo-claro);
      color: var(--texto-escuro);
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark {
      background-color: var(--fundo-escuro);
      color: var(--texto-claro);
    }
    header {
      text-align: center;
      margin-bottom: 25px;
    }
    header h1 {
      margin: 0 0 5px 0;
      color: var(--dourado);
    }
    header h2 {
      margin: 0;
      font-weight: normal;
      color: var(--dourado-escuro);
    }
    #temaToggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: var(--dourado);
      border: none;
      color: var(--branco);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.3s;
      z-index: 100;
    }
    #temaToggle:hover {
      background-color: var(--dourado-escuro);
    }
    #totalCard {
      background-color: var(--dourado);
      color: var(--branco);
      font-size: 1.2rem;
      font-weight: 700;
      padding: 15px 25px;
      border-radius: 10px;
      width: fit-content;
      margin: 0 auto 30px auto;
      box-shadow: 0 4px 15px rgba(139, 113, 36, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #totalCard.dark {
      background-color: var(--dourado-escuro);
    }
    .dashboard {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 25px;
    }
    .chart-container {
      background: var(--branco);
      border: 2px solid var(--dourado);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
      width: 320px;
      transition: background-color 0.3s, border-color 0.3s;
    }
    body.dark .chart-container {
      background: #1e1e1e;
      border-color: var(--dourado-escuro);
    }
    canvas {
      display: block;
      max-width: 100%;
      height: 240px !important;
    }
    #leadsSection {
      max-width: 960px;
      margin: 0 auto;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      color: inherit;
      background: var(--branco);
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      transition: background-color 0.3s;
    }
    body.dark table {
      background: #1e1e1e;
    }
    th, td {
      padding: 12px 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
      vertical-align: middle;
    }
    body.dark th, body.dark td {
      border-color: #444;
    }
    th {
      background-color: var(--dourado);
      color: var(--branco);
      position: sticky;
      top: 0;
      z-index: 2;
    }
    button.action-btn {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      margin-right: 6px;
      transition: transform 0.15s ease;
    }
    button.action-btn:hover {
      transform: scale(1.2);
    }
    button.excluir-btn {
      color: #d9534f;
    }
    button.salvar-btn {
      color: #28a745;
    }
    button.cancelar-btn {
      color: #6c757d;
    }
    select.status-select {
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 5px;
      border: 1.5px solid var(--dourado);
      background-color: var(--branco);
      color: var(--preto);
      transition: background-color 0.3s, border-color 0.3s;
    }
    body.dark select.status-select {
      background-color: #333;
      color: var(--texto-claro);
      border-color: var(--dourado-escuro);
    }
    #buttonsBar {
      max-width: 960px;
      margin: 0 auto 25px auto;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }
    #buttonsBar button {
      background-color: var(--dourado);
      border: none;
      padding: 12px 18px;
      border-radius: 8px;
      color: var(--branco);
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #buttonsBar button:hover {
      background-color: var(--dourado-escuro);
    }
    input[type="file"] {
      display: none;
    }
    label.import-label {
      cursor: pointer;
      background-color: var(--dourado);
      color: var(--branco);
      padding: 12px 18px;
      border-radius: 8px;
      font-weight: 700;
      transition: background-color 0.3s;
    }
    label.import-label:hover {
      background-color: var(--dourado-escuro);
    }
  </style>
</head>
<body>
  <header>
    <h1>Raros Capital</h1>
    <h2>Relat√≥rio de Leads</h2>
  </header>

  <button id="temaToggle" title="Alternar tema">üåô</button>

  <div id="totalCard">Valor Total: R$ 0,00</div>

  <div class="dashboard">
    <div class="chart-container">
      <canvas id="chartBem"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="chartMes"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="chartValor"></canvas>
    </div>
  </div>

  <div id="buttonsBar">
    <button id="exportPDFBtn">üìÑ Exportar PDF</button>
    <button id="exportClientesBtn">üë• Exportar Clientes (CSV)</button>
    <label for="importFile" class="import-label">üì• Importar Dados (Excel)</label>
    <input type="file" id="importFile" accept=".xlsx,.xls" />
  </div>

  <div id="leadsSection">
    <table id="leadsTable">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Email</th>
          <th>WhatsApp</th>
          <th>Valor (R$)</th>
          <th>Status</th>
          <th>Data</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Bibliotecas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      updateDoc,
      doc,
      addDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2RmhrsTe-o1jE3pVbFLKDl11m8zFW7tk",
      authDomain: "site-raros.firebaseapp.com",
      projectId: "site-raros",
      storageBucket: "site-raros.appspot.com",
      messagingSenderId: "610375954172",
      appId: "1:610375954172:web:6c1cf57ef39d6e93a1f179",
      measurementId: "G-S3ZLSEE4GP"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const leadsTableBody = document.querySelector("#leadsTable tbody");
    const totalCard = document.getElementById("totalCard");
    const exportPDFBtn = document.getElementById("exportPDFBtn");
    const exportClientesBtn = document.getElementById("exportClientesBtn");
    const importFileInput = document.getElementById("importFile");
    const temaToggle = document.getElementById("temaToggle");

    let leads = [];
    let editRowId = null;
    let chartBem, chartMes, chartValor;

    // Alternar tema
    temaToggle.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      if(document.body.classList.contains("dark")){
        temaToggle.textContent = "‚òÄÔ∏è";
      } else {
        temaToggle.textContent = "üåô";
      }
    });

    // Carregar leads do Firestore
    async function carregarLeads() {
      leadsTableBody.innerHTML = "<tr><td colspan='7'>Carregando...</td></tr>";
      try {
        const querySnapshot = await getDocs(collection(db, "leads"));
        leads = [];
        querySnapshot.forEach(docSnap => {
          leads.push({ id: docSnap.id, ...docSnap.data() });
        });
        renderTabela();
        atualizarTotal();
        atualizarGraficos();
      } catch (error) {
        console.error("Erro ao carregar leads:", error);
        leadsTableBody.innerHTML = "<tr><td colspan='7'>Erro ao carregar leads.</td></tr>";
      }
    }

    // Renderizar tabela
    function renderTabela() {
      if(leads.length === 0){
        leadsTableBody.innerHTML = "<tr><td colspan='7'>Nenhum lead encontrado.</td></tr>";
        return;
      }
      leadsTableBody.innerHTML = "";
      leads.forEach(lead => {
        if(editRowId === lead.id){
          // Linha editando
          leadsTableBody.innerHTML += `
          <tr data-id="${lead.id}">
            <td><input type="text" class="edit-nome" value="${lead.nome}" /></td>
            <td><input type="email" class="edit-email" value="${lead.email}" /></td>
            <td><input type="tel" class="edit-telefone" value="${lead.telefone}" /></td>
            <td><input type="number" class="edit-valor" step="0.01" min="0" value="${Number(lead.valor).toFixed(2)}" /></td>
            <td>
              <select class="status-select edit-status">
                <option value="Novo" ${lead.status === "Novo" ? "selected" : ""}>Novo</option>
                <option value="Negocia√ß√£o" ${lead.status === "Negocia√ß√£o" ? "selected" : ""}>Negocia√ß√£o</option>
                <option value="Ganho" ${lead.status === "Ganho" ? "selected" : ""}>Ganho</option>
                <option value="Perdido" ${lead.status === "Perdido" ? "selected" : ""}>Perdido</option>
              </select>
            </td>
            <td>${new Date(lead.criadoEm).toLocaleString("pt-BR")}</td>
            <td>
              <button class="action-btn salvar-btn" title="Salvar">üíæ</button>
              <button class="action-btn cancelar-btn" title="Cancelar">‚ùå</button>
            </td>
          </tr>`;
        } else {
          leadsTableBody.innerHTML += `
          <tr data-id="${lead.id}">
            <td>${lead.nome}</td>
            <td>${lead.email}</td>
            <td>${lead.telefone}</td>
            <td>R$ ${Number(lead.valor).toLocaleString("pt-BR", {minimumFractionDigits:2})}</td>
            <td>
              <select class="status-select" data-id="${lead.id}">
                <option value="Novo" ${lead.status === "Novo" ? "selected" : ""}>Novo</option>
                <option value="Negocia√ß√£o" ${lead.status === "Negocia√ß√£o" ? "selected" : ""}>Negocia√ß√£o</option>
                <option value="Ganho" ${lead.status === "Ganho" ? "selected" : ""}>Ganho</option>
                <option value="Perdido" ${lead.status === "Perdido" ? "selected" : ""}>Perdido</option>
              </select>
            </td>
            <td>${new Date(lead.criadoEm).toLocaleString("pt-BR")}</td>
            <td>
              <button class="action-btn editar-btn" title="Editar">‚úèÔ∏è</button>
            </td>
          </tr>`;
        }
      });

      // Adiciona eventos aos bot√µes e selects
      document.querySelectorAll(".editar-btn").forEach(btn => {
        btn.onclick = () => {
          if(editRowId) {
            alert("Finalize a edi√ß√£o atual antes de editar outro lead.");
            return;
          }
          const tr = btn.closest("tr");
          editRowId = tr.getAttribute("data-id");
          renderTabela();
        };
      });

      document.querySelectorAll(".salvar-btn").forEach(btn => {
        btn.onclick = async () => {
          const tr = btn.closest("tr");
          const id = tr.getAttribute("data-id");
          const nome = tr.querySelector(".edit-nome").value.trim();
          const email = tr.querySelector(".edit-email").value.trim();
          const telefone = tr.querySelector(".edit-telefone").value.trim();
          const valor = parseFloat(tr.querySelector(".edit-valor").value);
          const status = tr.querySelector(".edit-status").value;

          if(!nome || !email || !telefone || isNaN(valor)){
            alert("Por favor, preencha todos os campos corretamente.");
            return;
          }

          try {
            await updateDoc(doc(db, "leads", id), {
              nome,
              email,
              telefone,
              valor,
              status
            });
            const leadIndex = leads.findIndex(l => l.id === id);
            leads[leadIndex] = { ...leads[leadIndex], nome, email, telefone, valor, status };
            editRowId = null;
            renderTabela();
            atualizarTotal();
            atualizarGraficos();
          } catch (error) {
            console.error("Erro ao salvar lead:", error);
            alert("Erro ao salvar altera√ß√µes.");
          }
        };
      });

      document.querySelectorAll(".cancelar-btn").forEach(btn => {
        btn.onclick = () => {
          editRowId = null;
          renderTabela();
        };
      });

      document.querySelectorAll("select.status-select:not(.edit-status)").forEach(sel => {
        sel.onchange = async () => {
          const id = sel.getAttribute("data-id");
          const novoStatus = sel.value;
          try {
            await updateDoc(doc(db, "leads", id), { status: novoStatus });
            const leadIndex = leads.findIndex(l => l.id === id);
            leads[leadIndex].status = novoStatus;
            atualizarGraficos();
          } catch (error) {
            console.error("Erro ao atualizar status:", error);
            alert("Erro ao atualizar status.");
          }
        };
      });
    }

    // Atualizar valor total e cart√£o
    function atualizarTotal() {
      const total = leads.reduce((acc, lead) => acc + (Number(lead.valor) || 0), 0);
      totalCard.textContent = `Valor Total: R$ ${total.toLocaleString("pt-BR", {minimumFractionDigits: 2})}`;
      if(document.body.classList.contains("dark")){
        totalCard.classList.add("dark");
      } else {
        totalCard.classList.remove("dark");
      }
    }

    // Configurar gr√°ficos
    function atualizarGraficos() {
      const ctxBem = document.getElementById("chartBem").getContext("2d");
      const ctxMes = document.getElementById("chartMes").getContext("2d");
      const ctxValor = document.getElementById("chartValor").getContext("2d");

      // Dados para chartBem (status)
      const statusCounts = leads.reduce((acc, lead) => {
        acc[lead.status] = (acc[lead.status] || 0) + 1;
        return acc;
      }, {});
      const labelsBem = Object.keys(statusCounts);
      const dataBem = Object.values(statusCounts);

      // Dados para chartMes (m√™s)
      const mesesLabels = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
      const mesesCount = Array(12).fill(0);
      leads.forEach(lead => {
        const dt = new Date(lead.criadoEm);
        if (!isNaN(dt)) mesesCount[dt.getMonth()]++;
      });

      // Dados para chartValor (valores por status)
      const valorPorStatus = leads.reduce((acc, lead) => {
        acc[lead.status] = (acc[lead.status] || 0) + (Number(lead.valor) || 0);
        return acc;
      }, {});
      const labelsValor = Object.keys(valorPorStatus);
      const dataValor = Object.values(valorPorStatus);

      // Destruir gr√°ficos antigos se existirem para evitar duplica√ß√£o
      if(chartBem) chartBem.destroy();
      if(chartMes) chartMes.destroy();
      if(chartValor) chartValor.destroy();

      const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "bottom", labels: { color: document.body.classList.contains("dark") ? "#ddd" : "#333" } },
          tooltip: { mode: "index", intersect: false },
        },
        scales: {
          x: { ticks: { color: document.body.classList.contains("dark") ? "#ddd" : "#333" } },
          y: { ticks: { color: document.body.classList.contains("dark") ? "#ddd" : "#333" }, beginAtZero: true }
        }
      };

      chartBem = new Chart(ctxBem, {
        type: "doughnut",
        data: {
          labels: labelsBem,
          datasets: [{
            label: "Status dos Leads",
            data: dataBem,
            backgroundColor: ["#f6c23e", "#1cc88a", "#36b9cc", "#e74a3b"],
            borderColor: "#fff",
            borderWidth: 2,
          }],
        },
        options: {
          ...commonOptions,
          maintainAspectRatio: false,
          aspectRatio: 1,
        },
      });

      chartMes = new Chart(ctxMes, {
        type: "bar",
        data: {
          labels: mesesLabels,
          datasets: [{
            label: "Leads por M√™s",
            data: mesesCount,
            backgroundColor: "#4e73df",
          }],
        },
        options: {
          ...commonOptions,
          scales: {
            x: { ticks: { color: document.body.classList.contains("dark") ? "#ddd" : "#333" } },
            y: { beginAtZero: true, ticks: { color: document.body.classList.contains("dark") ? "#ddd" : "#333" } },
          }
        },
      });

      chartValor = new Chart(ctxValor, {
        type: "bar",
        data: {
          labels: labelsValor,
          datasets: [{
            label: "Valor Total por Status (R$)",
            data: dataValor,
            backgroundColor: ["#f6c23e", "#1cc88a", "#36b9cc", "#e74a3b"],
          }],
        },
        options: {
          ...commonOptions,
          scales: {
            x: { ticks: { color: document.body.classList.contains("dark") ? "#ddd" : "#333" } },
            y: { beginAtZero: true, ticks: { color: document.body.classList.contains("dark") ? "#ddd" : "#333" } },
          }
        },
      });
    }

    // Exportar PDF com gr√°ficos e total em uma p√°gina
    async function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "pt", "a4");

      pdf.setFontSize(20);
      pdf.setTextColor("#bfa34a");
      pdf.text("Raros Capital", 40, 30);

      pdf.setFontSize(16);
      pdf.setTextColor("#8c7b2a");
      pdf.text("Relat√≥rio de Leads", 40, 55);

      // Total geral
      const total = leads.reduce((acc, l) => acc + (Number(l.valor) || 0), 0);
      pdf.setFontSize(14);
      pdf.setTextColor("#222");
      pdf.text(`Total geral: R$ ${total.toLocaleString("pt-BR", { minimumFractionDigits: 2 })}`, 40, 80);

      // Tamanhos reduzidos para caber lado a lado na p√°gina
      const marginX = 40;
      const chartWidth = (pdf.internal.pageSize.getWidth() - marginX * 2 - 20) / 3 * 0.8;
      const chartHeight = chartWidth * 0.8;

      const imgBem = chartBem.toBase64Image();
      const imgMes = chartMes.toBase64Image();
      const imgValor = chartValor.toBase64Image();

      pdf.addImage(imgBem, "PNG", marginX, 100, chartWidth, chartHeight);
      pdf.addImage(imgMes, "PNG", marginX + chartWidth + 10, 100, chartWidth, chartHeight);
      pdf.addImage(imgValor, "PNG", marginX + (chartWidth + 10) * 2, 100, chartWidth, chartHeight);

      pdf.save("relatorio_leads.pdf");
    }

    // Exportar clientes para CSV
    function exportarClientesCSV() {
      if (leads.length === 0) {
        alert("Nenhum dado para exportar.");
        return;
      }

      const header = ["Nome", "Email", "WhatsApp", "Valor (R$)", "Status", "Data"];
      const rows = leads.map(l => [
        l.nome,
        l.email,
        l.telefone,
        Number(l.valor).toFixed(2).replace(".", ","),
        l.status,
        new Date(l.criadoEm).toLocaleString("pt-BR")
      ]);

      let csvContent = "data:text/csv;charset=utf-8,";
      csvContent += header.join(";") + "\r\n";
      rows.forEach(row => {
        csvContent += row.join(";") + "\r\n";
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "clientes.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Importar Excel e adicionar no Firestore
    importFileInput.addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        // jsonData esperado: [{nome, email, telefone, valor, status, criadoEm}]
        for (const item of jsonData) {
          // Validar e ajustar campos
          if(!item.nome || !item.email) continue;
          try {
            await addDoc(collection(db, "leads"), {
              nome: item.nome,
              email: item.email,
              telefone: item.telefone || "",
              valor: Number(item.valor) || 0,
              status: item.status || "Novo",
              criadoEm: item.criadoEm ? new Date(item.criadoEm).toISOString() : new Date().toISOString()
            });
          } catch (error) {
            console.error("Erro ao adicionar lead importado:", error);
          }
        }
        alert("Importa√ß√£o conclu√≠da!");
        importFileInput.value = null;
        carregarLeads();
      };
      reader.readAsArrayBuffer(file);
    });

    exportPDFBtn.addEventListener("click", exportarPDF);
    exportClientesBtn.addEventListener("click", exportarClientesCSV);

    carregarLeads();
  </script>
</body>
</html>
